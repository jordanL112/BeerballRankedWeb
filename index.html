<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Beerball Leaderboard</title>

<style>
  body{
    background:#0f0f0f;
    color:white;
    font-family:Arial, sans-serif;
    margin:20px;
  }

  nav{
    display:flex;
    justify-content:center;
    gap:15px;
    margin-bottom:20px;
  }
  .nav-button{
    padding:10px 20px;
    background-color:#444;
    border:none;
    color:white;
    cursor:pointer;
  }
  .nav-button:hover{ background-color:#666; }

  .section{ display:none; }

  table{
    width:100%;
    border-collapse:collapse;
  }
  th, td{
    padding:10px;
    border-bottom:1px solid #333;
    text-align:center;
  }
  th{
    position:sticky;
    top:0;
    background:#000;
  }
  tr:hover{ background:#222; }

  .rank-icon{
    width:45px;
    height:45px;
  }

  /* Optional: make flashing look smoother than MATLAB */
  .flash-smooth{
    transition: color 180ms linear, font-weight 180ms linear;
    will-change: color;
  }
</style>
</head>

<body>

<h1>üç∫ Beerball Leaderboard</h1>

<nav>
  <button class="nav-button" onclick="showSection('leaderboard')">Leaderboard</button>
  <button class="nav-button" onclick="showSection('clans')">Clans</button>
  <button class="nav-button" onclick="showSection('playerCards')">Player Cards</button>
  <button class="nav-button" onclick="showSection('shop')">Points Shop</button>
</nav>

<div id="leaderboard" class="section">
  <h2>Leaderboard</h2>
  <table>
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Tier</th>
        <th>ELO</th>
        <th>Games</th>
        <th>W</th>
        <th>L</th>
        <th>Win %</th>
        <th>Team</th>
        <th>Clan</th>
      </tr>
    </thead>
    <tbody id="board"></tbody>
  </table>
</div>

<div id="clans" class="section">
  <h2>Clans</h2>
  <p>(Coming soon)</p>
</div>

<div id="playerCards" class="section">
  <h2>Player Cards</h2>
  <p>(Coming soon)</p>
</div>

<div id="shop" class="section">
  <h2>Points Shop</h2>
  <p>(Coming soon)</p>
</div>

<script>
/* ------------------ SECTION SWITCH ------------------ */
function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  const active = document.getElementById(sectionId);
  if (active) active.style.display = 'block';
}

function safeText(x) {
  if (Array.isArray(x)) return x.join(" ");
  if (x === null || x === undefined) return "";
  return String(x);
}

/* ------------------ SAFE NORMALIZERS ------------------ */
function normText(x) {
  // Handles: "Name", ["Name"], [], null
  if (Array.isArray(x)) return x.join(" ").trim();
  if (x === null || x === undefined) return "";
  return String(x).trim();
}

/* Accepts:
   - MATLAB-style [0.85,0.1,0.1]
   - "rgb(255,0,0)"
   - "#ff0000"
   - null/undefined
*/
function colorToCss(c) {
  if (!c) return null;

  // Array like [0,0,0] or [r,g,b]
  if (Array.isArray(c) && c.length >= 3) {
    const r = Math.round(Number(c[0]) * 255);
    const g = Math.round(Number(c[1]) * 255);
    const b = Math.round(Number(c[2]) * 255);
    return `rgb(${r},${g},${b})`;
  }

  // String like "#ff00aa" or "rgb(...)"
  return String(c);
}

function isBlackColor(c) {
  // Treat null/undefined as black/disabled
  if (!c) return true;

  if (Array.isArray(c) && c.length >= 3) {
    return Number(c[0]) === 0 && Number(c[1]) === 0 && Number(c[2]) === 0;
  }

  const s = String(c).toLowerCase().replace(/\s+/g,'');
  return s === "#000" || s === "#000000" || s === "rgb(0,0,0)" || s === "black";
}

/* ------------------ ICONS ------------------ */
function tierToIcon(tier) {
  tier = normText(tier);   // <-- THIS LINE FIXES IT

  if (tier.startsWith("Godly")) return "icons/godly.png";
  if (tier.startsWith("Master")) return "icons/master.png";
  if (tier.startsWith("Diamond")) return "icons/diamond.png";
  if (tier.startsWith("Platinum")) return "icons/platinum.png";
  if (tier.startsWith("Gold")) return "icons/gold.png";
  if (tier.startsWith("Silver")) return "icons/silver.png";
  return "icons/bronze.png";
}


/* ------------------ MATLAB FLASH PORT ------------------
MATLAB name flash:
- Period ~0.6s
- Alternates base state and pulse state
- Base: BLACK -> WEB: WHITE
- Pulse: tier color + bold
- Godly alternates between dark gold and bright blue each pulse

MATLAB group flash:
- Period ~0.7s
- Alternates base and pulse
- Base: BLACK -> WEB: WHITE
- Pulse: purchased group color + bold
-------------------------------------------------------- */

/* Tier -> color mapping from MATLAB */
function tierPulseColor(tier, godlyFlip) {
  switch (tier) {
    case "Godly":
      // flip between bright blue and dark gold (same as MATLAB)
      return godlyFlip ? "rgb(0,179,255)" : "rgb(153,128,26)";
    case "Master":
      return "rgb(102,0,153)";
    case "Diamond I":
    case "Diamond II":
    case "Diamond III":
      return "rgb(0,51,153)";
    case "Silver I":
    case "Silver II":
    case "Silver III":
      return "rgb(191,191,191)";
    case "Bronze I":
    case "Bronze II":
    case "Bronze III":
      return "rgb(102,51,0)";
    default:
      return "white";
  }
}

function startTierFlash(el, tier) {
  el.classList.add("flash-smooth");

  let state = true;      // true -> base, false -> pulse (matching MATLAB toggle)
  let godlyFlip = false; // for Godly alternating pulse color

  setInterval(() => {
    if (state) {
      // BASE STATE (WEB = WHITE)
      el.style.color = "white";
      el.style.fontWeight = "normal";
    } else {
      // PULSE STATE
      el.style.fontWeight = "bold";
      if (tier === "Godly") {
        el.style.color = tierPulseColor(tier, godlyFlip);
        godlyFlip = !godlyFlip;
      } else {
        el.style.color = tierPulseColor(tier, false);
      }
    }
    state = !state;
  }, 600);
}

function startGroupFlash(el, cssColor) {
  el.classList.add("flash-smooth");

  let state = true;
  setInterval(() => {
    if (state) {
      // BASE (WHITE)
      el.style.color = "white";
      el.style.fontWeight = "normal";
    } else {
      // PULSE
      el.style.color = cssColor;
      el.style.fontWeight = "bold";
    }
    state = !state;
  }, 700);
}

/* ------------------ RENDER ------------------ */
fetch("leaderboard.json")
  .then(r => r.json())
  .then(data => {
    const tbody = document.getElementById("board");
    if (!tbody) return;

    data.forEach(p => {
      const name = normText(p.name);
      const team = normText(p.team);
      const clan = normText(p.clan);

      const winPct = (p.games && p.games > 0)
        ? ((p.wins / p.games) * 100).toFixed(1) + "%"
        : "0.0%";

      // Build row
      const row = document.createElement("tr");

      // NAME span (so we can flash it)
      const nameSpan = document.createElement("span");
      nameSpan.textContent = name;
      nameSpan.style.color = "white";

      // TEAM span
      const teamSpan = document.createElement("span");
      teamSpan.textContent = team;
      teamSpan.style.color = "white";

      // CLAN span
      const clanSpan = document.createElement("span");
      clanSpan.textContent = clan;
      clanSpan.style.color = "white";

      row.innerHTML = `
        <td class="rank-cell">
          <span>${p.rank}</span>
          <img class="rank-icon" src="${tierToIcon(normText(p.tier))}" alt="">
        </td>
        <td class="name-cell"></td>
        <td>${normText(p.tier)}</td>
        <td>${p.elo}</td>
        <td>${p.games}</td>
        <td>${p.wins}</td>
        <td>${p.losses}</td>
        <td>${winPct}</td>
        <td class="team-cell"></td>
        <td class="clan-cell"></td>
      `;

      row.querySelector(".name-cell").appendChild(nameSpan);
      row.querySelector(".team-cell").appendChild(teamSpan);
      row.querySelector(".clan-cell").appendChild(clanSpan);

      tbody.appendChild(row);

      // ---- Apply flashing rules ----

      // Player name flashes ONLY if purchased (p.hasFlash === true)
      if (p.hasFlash === true) {
        startTierFlash(nameSpan, normText(p.tier));
      }

      // Team flashes ONLY if a non-black teamColor exists
      // (supports p.teamColor: [0,0,0] or "#rrggbb" or "rgb(...)")
      if (team && p.teamColor && !isBlackColor(p.teamColor)) {
        startGroupFlash(teamSpan, colorToCss(p.teamColor));
      }

      // Clan flashes ONLY if a non-black clanColor exists
      if (clan && p.clanColor && !isBlackColor(p.clanColor)) {
        startGroupFlash(clanSpan, colorToCss(p.clanColor));
      }
    });
  })
  .catch(err => {
    // If it ever blanks again, this will at least show in DevTools console
    console.error("Error loading leaderboard.json:", err);
  });

// Default view
showSection("leaderboard");
</script>

</body>
</html>
